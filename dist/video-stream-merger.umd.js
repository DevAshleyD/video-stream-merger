!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(0,function(){function t(e){if(!(this instanceof t))return new t(e);e=e||{};var i=window.AudioContext||window.webkitAudioContext,a=!(!i||!(this._audioCtx=e.audioContext||new i).createMediaStreamDestination),o=!!document.createElement("canvas").captureStream;if(!a||!o)throw new Error("Unsupported browser");this.width=e.width||400,this.height=e.height||300,this.fps=e.fps||25,this.clearRect=void 0===e.clearRect||e.clearRect,this._canvas=document.createElement("canvas"),this._canvas.setAttribute("width",this.width),this._canvas.setAttribute("height",this.height),this._canvas.setAttribute("style","position:fixed; left: 110%; pointer-events: none"),this._ctx=this._canvas.getContext("2d"),this._streams=[],this._audioDestination=this._audioCtx.createMediaStreamDestination(),this._setupConstantNode(),this.started=!1,this.result=null,this._backgroundAudioHack()}module.exports=t,t.prototype.getAudioContext=function(){return this._audioCtx},t.prototype.getAudioDestination=function(){return this._audioDestination},t.prototype.getCanvasContext=function(){return this._ctx},t.prototype._backgroundAudioHack=function(){var t=this._audioCtx.createConstantSource(),e=this._audioCtx.createGain();e.gain.value=.001,t.connect(e),e.connect(this._audioCtx.destination),t.start()},t.prototype._setupConstantNode=function(){var t=this._audioCtx.createConstantSource();t.start();var e=this._audioCtx.createGain();e.gain.value=0,t.connect(e),e.connect(this._audioDestination)},t.prototype.updateIndex=function(t,e){"string"==typeof t&&(t={id:t}),e=null==e?0:e;for(var i=0;i<this._streams.length;i++)t.id===this._streams[i].id&&(this._streams[i].index=e);this._sortStreams()},t.prototype._sortStreams=function(){this._streams=this._streams.sort(function(t,e){return t.index-e.index})},t.prototype.addMediaElement=function(t,e,i){if((i=i||{}).x=i.x||0,i.y=i.y||0,i.width=i.width||this.width,i.height=i.height||this.height,i.mute=i.mute||i.muted||!1,i.oldDraw=i.draw,i.oldAudioEffect=i.audioEffect,i.draw="VIDEO"===e.tagName||"IMG"===e.tagName?function(t,a,o){i.oldDraw?i.oldDraw(t,e,o):(t.drawImage(e,i.x,i.y,i.width,i.height),o())}:null,!i.mute){var a=e._mediaElementSource||this.getAudioContext().createMediaElementSource(e);e._mediaElementSource=a,a.connect(this.getAudioContext().destination);var o=this.getAudioContext().createGain();a.connect(o),e.muted?(e.muted=!1,e.volume=.001,o.gain.value=1e3):o.gain.value=1,i.audioEffect=function(t,e){i.oldAudioEffect?i.oldAudioEffect(o,e):o.connect(e)},i.oldAudioEffect=null}this.addStream(t,i)},t.prototype.addStream=function(t,e){if("string"==typeof t)return this._addData(t,e);var i={isData:!1};i.x=(e=e||{}).x||0,i.y=e.y||0,i.width=e.width||this.width,i.height=e.height||this.height,i.draw=e.draw||null,i.mute=e.mute||e.muted||!1,i.audioEffect=e.audioEffect||null,i.index=null==e.index?0:e.index,i.hasVideo=t.getVideoTracks().length>0;for(var a=null,o=0;o<this._streams.length;o++)this._streams[o].id===t.id&&(a=this._streams[o].element);a||((a=document.createElement("video")).autoplay=!0,a.muted=!0,a.srcObject=t,a.setAttribute("style","position:fixed; left: 0px; top:0px; pointer-events: none; opacity:0;"),document.body.appendChild(a),i.mute||(i.audioSource=this._audioCtx.createMediaStreamSource(t),i.audioOutput=this._audioCtx.createGain(),i.audioOutput.gain.value=1,i.audioEffect?i.audioEffect(i.audioSource,i.audioOutput):i.audioSource.connect(i.audioOutput),i.audioOutput.connect(this._audioDestination))),i.element=a,i.id=t.id||null,this._streams.push(i),this._sortStreams()},t.prototype.removeStream=function(t){"string"==typeof t&&(t={id:t});for(var e=0;e<this._streams.length;e++)t.id===this._streams[e].id&&(this._streams[e].audioSource&&(this._streams[e].audioSource=null),this._streams[e].audioOutput&&(this._streams[e].audioOutput.disconnect(this._audioDestination),this._streams[e].audioOutput=null),this._streams[e]=null,this._streams.splice(e,1),e--)},t.prototype._addData=function(t,e){var i={isData:!0};i.draw=(e=e||{}).draw||null,i.audioEffect=e.audioEffect||null,i.id=t,i.element=null,i.index=null==e.index?0:e.index,i.audioEffect&&(i.audioOutput=this._audioCtx.createGain(),i.audioOutput.gain.value=1,i.audioEffect(null,i.audioOutput),i.audioOutput.connect(this._audioDestination)),this._streams.push(i),this._sortStreams()},t.prototype._requestAnimationFrame=function(t){document.hidden?setTimeout(t,0):requestAnimationFrame(t)},t.prototype.start=function(){this.started=!0,this._requestAnimationFrame(this._draw.bind(this)),this.result=this._canvas.captureStream(this.fps);var t=this.result.getAudioTracks()[0];t&&this.result.removeTrack(t);var e=this._audioDestination.stream.getAudioTracks();this.result.addTrack(e[0])},t.prototype._draw=function(){var t=this;if(t.started){var e=t._streams.length;t.clearRect&&t._ctx.clearRect(0,0,t.width,t.height),t._streams.forEach(function(e){e.draw?e.draw(t._ctx,e.element,i):!e.isData&&e.hasVideo?(t._ctx.drawImage(e.element,e.x,e.y,e.width,e.height),i()):i()}),0===t._streams.length&&i()}function i(){--e<=0&&t._requestAnimationFrame(t._draw.bind(t))}},t.prototype.destroy=function(){this.started=!1,this._canvas=null,this._ctx=null,this._streams=[],this._audioCtx.close(),this._audioCtx=null,this._audioDestination=null,this.result.getTracks().forEach(function(t){t.stop()}),this.result=null},module.exports=t});
//# sourceMappingURL=video-stream-merger.umd.js.map
