(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.VideoStreamMerger = f()}})(function(){var define,module,exports;return (function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";function WebAudioBackend(a){var b=window.AudioContext||window.webkitAudioContext,c=!!(b&&(this._audioCtx=a.audioContext||new b).createMediaStreamDestination);if(!c)throw new Error("audio backend \"WebAudio\" is not supported in this browser");this._audioDestination=this._audioCtx.createMediaStreamDestination(),this._videoSyncDelayNode=this._audioCtx.createDelay(5),this._videoSyncDelayNode.connect(this._audioDestination),this._nodeReferences=new Set,this._setupConstantNode(),this._backgroundAudioHack()}WebAudioBackend.prototype.destroyAudioSource=function(){},WebAudioBackend.prototype.destroyAudioSink=function(a){a.disconnect(this._videoSyncDelayNode)},WebAudioBackend.prototype.getAudioDestination=function(){return this._audioDestination},WebAudioBackend.prototype._backgroundAudioHack=function(){var a=this._audioCtx.createConstantSource(),b=this._audioCtx.createGain();b.gain.value=.001,a.connect(b),b.connect(this._audioCtx.destination),a.start()},WebAudioBackend.prototype._setupConstantNode=function(){var a=this._audioCtx.createConstantSource();a.start();var b=this._audioCtx.createGain();b.gain.value=0,a.connect(b),b.connect(this._videoSyncDelayNode)},WebAudioBackend.prototype.createAudioEffect=function(a){var b=this._audioCtx.createGain();return b.gain.value=1,a(null,b),b.connect(this._videoSyncDelayNode),b},WebAudioBackend.prototype.initDefaultAudioEffect=function(a,b){a.connect(b)},WebAudioBackend.prototype.updateAudioDelay=function(a){this._videoSyncDelayNode.delayTime.setValueAtTime(a/1e3,this._audioCtx.currentTime)},WebAudioBackend.prototype.createSourceFromElement=function(a){var b=a._VSMSourceNode||this._audioCtx.createMediaElementSource(a);b.origin="element",b.connect(this._audioCtx.destination);var c=this._audioCtx.createGain();return b.connect(c),a.muted?(a.muted=!1,a.volume=.001,c.gain.value=1e3):c.gain.value=1,a._VSMSourceNode=b,a._VSMGainNodes=a._VSMGainNodes||[],a._VSMGainNodes.push(c),c},WebAudioBackend.prototype.createSourceFromMediaStream=function(a){var b=this._audioCtx.createMediaStreamSource(a);return a._VSMSourceNode=b,b},WebAudioBackend.prototype.createSink=function(){var a=this._audioCtx.createGain();return a.gain.value=1,a.connect(this._videoSyncDelayNode),this._nodeReferences.add(a),a},WebAudioBackend.prototype.getContext=function(){return this._audioCtx},WebAudioBackend.prototype.getAudioTracks=function(){return this._audioDestination.stream.getAudioTracks()},WebAudioBackend.prototype.destroy=function(){this._audioCtx.close(),this._audioCtx=null,this._audioDestination=null,this._videoSyncDelayNode=null},module.exports=WebAudioBackend;

},{}],2:[function(require,module,exports){
"use strict";function CanvasBackend(){var a=!!document.createElement("canvas").captureStream;if(!a)throw new Error("video backend \"Canvas\" is not supported in this browser");this._canvas=document.createElement("canvas"),this._canvas.setAttribute("width",this.width),this._canvas.setAttribute("height",this.height),this._canvas.setAttribute("style","position:fixed; left: 110%; pointer-events: none"),this._ctx=this._canvas.getContext("2d")}CanvasBackend.prototype.createSourceFromElement=function(a){return a},CanvasBackend.prototype.createSourceFromMediaStream=function(a){var b=document.createElement("video");return b.autoplay=!0,b.muted=!0,b.srcObject=a,b.setAttribute("style","position:fixed; left: 0px; top:0px; pointer-events: none; opacity:0;"),document.body.appendChild(b),b},CanvasBackend.prototype.setResolution=function(a,b){this._canvas.setAttribute("width",a),this._canvas.setAttribute("height",b)},CanvasBackend.prototype.getContext=function(){return this._ctx},CanvasBackend.prototype.clear=function(){this._ctx.clearRect(0,0,this.width,this.height)},CanvasBackend.prototype.drawVideoSource=function(a,b,c,d,e){this._ctx.drawImage(a,b,c,d,e)},CanvasBackend.prototype.getOutputMediaStream=function(){var a=this._canvas.captureStream(this.fps);return a.getAudioTracks()[0].forEach(function(b){a.removeTrack(b)}),a},CanvasBackend.prototype.destroyVideoSource=function(a){a.remove()},CanvasBackend.prototype.requestAnimationFrame=function(a){var b=!1,c=setInterval(function(){!b&&document.hidden&&(b=!0,clearInterval(c),a())},1e3/this.fps);requestAnimationFrame(function(){b||(b=!0,clearInterval(c),a())})},CanvasBackend.prototype.destroy=function(){this._canvas=null,this._ctx=null},module.exports=CanvasBackend;

},{}],3:[function(require,module,exports){
"use strict";var CanvasBackend=require("./backends/video/canvas"),WebAudioBackend=require("./backends/audio/webaudio");module.exports=VideoStreamMerger;function VideoStreamMerger(a){return this instanceof VideoStreamMerger?void(a=a||{},this.width=a.width||640,this.height=a.height||480,this.fps=a.fps||25,this.clearRect=!(a.clearRect!==void 0)||a.clearRect,this._videoBackend=new CanvasBackend(a),this._audioBackend=new WebAudioBackend(a),this._streams=[],this._frameCount=0,this.started=!1,this.result=null):new VideoStreamMerger(a)}VideoStreamMerger.prototype.setOutputSize=function(a,b){this.width=a,this.height=b,this._videoBackend.setResolution(this.width,this.height)},VideoStreamMerger.prototype.updateIndex=function(a,b){"string"==typeof a&&(a={id:a}),b=null==b?0:b;for(var c=0;c<this._streams.length;c++)a.id===this._streams[c].id&&(this._streams[c].index=b);this._zSortStreams()},VideoStreamMerger.prototype._zSortStreams=function(){this._streams=this._streams.sort(function(c,a){return c.index-a.index})},VideoStreamMerger.prototype.addMediaElement=function(a,b,c){var d=this;c=c||{};var e={x:c.x||0,y:c.y||0,width:c.width,height:c.height,mute:c.mute||c.muted||!1},f=c.draw,g=c.audioEffect;if("VIDEO"===b.tagName||"IMG"===b.tagName?(e.videoSource=this._videoBackend.createSourceFromElement(b),e.applyDrawEffect=function(a,b,c){if(f)f(a,e.videoSource,c);else{var g=null==e.width?d.width:e.width,h=null==e.height?d.height:e.height;d._videoBackend.drawVideoSource(e.videoSource,e.x,e.x,g,h),c()}}):e.applyDrawEffect=null,!e.mute){var h=this._audioBackend.createSourceFromElement(b),i=this._audioBackend.createSink(b);e.audioSource=h,e.audioSink=i,g?g(h,i):this._audioBackend.initDefaultAudioEffect(h,i)}this.addStream(a,e)},VideoStreamMerger.prototype.addStream=function(a,b){var c=this;if("string"==typeof a)return this._addData(a,b);b=b||{};for(var d={isData:!1,x:b.x||0,y:b.y||0,width:b.width,height:b.height,mute:b.mute||b.muted||!1,index:null==b.index?0:b.index,hasVideo:0<a.getVideoTracks().length},e=b.draw,f=b.audioEffect,g=null,h=0;h<this._streams.length;h++)this._streams[h].id===a.id&&(g=this._streams[h].videoSource);if(g||(g=this._videoBackend.createSourceFromMediaStream(a)),!d.mute){var j=this._audioBackend.createSourceFromMediaStream(a),k=this._audioBackend.createSink();d.audioSource=j,d.audioSink=k,f?f(j,k):this._audioBackend.initDefaultAudioEffect(j,k)}d.applyDrawEffect=function(a,b,f){if(e)e(a,g,f);else{var h=null==d.width?c.width:d.width,i=null==d.height?c.height:d.height;c._videoBackend.drawVideoSource(g,d.x,d.x,h,i),f()}},d.videoSource=g,d.id=a.id||null,this._streams.push(d),this._zSortStreams()},VideoStreamMerger.prototype.removeStream=function(a){for(var b,c="string"==typeof a?a:a.id,d=0;d<this._streams.length;d++)b=this._streams[d],c===b.id&&(b.videoSource&&(this._videoBackend.destroyVideoSource(b.videoSource),b.videoSource=null),b.audioSource&&(this._audioBackend.destroyAudioSource(b.audioSource),b.audioSource=null),b.audioSink&&(this._audioBackend.destroyAudioSink(b.audioSink),b.audioSink=null),b.element&&b.element.remove(),this._streams[d]=null,this._streams.splice(d,1),d--)},VideoStreamMerger.prototype._addData=function(a,b){b=b||{};var c={};c.isData=!0,c.applyDrawEffect=b.draw||null,c.id=a,c.element=null,c.index=null==b.index?0:b.index,b.audioEffect&&(c.audioEffect=this._audioBackend.createAudioEffect(b.audioEffect)),this._streams.push(c),this._zSortStreams()},VideoStreamMerger.prototype.start=function(){var a=this;this.started=!0,this._videoBackend.requestAnimationFrame(this._draw.bind(this)),this.result=this._videoBackend.getOutputMediaStream();var b=this._audioBackend.getAudioTracks();b.forEach(function(b){a.result.addTrack(b)})},VideoStreamMerger.prototype._draw=function(){var a=this;if(this.started){this._frameCount++;var b=null;0==this._frameCount%60&&(b=window.performance.now());var c=this._streams.length,d=function(){if(c--,0>=c){if(0==a._frameCount%60){var d=window.performance.now();a._audioBackend.updateAudioDelay(d-b)}a._videoBackend.requestAnimationFrame(a._draw.bind(a))}};this.clearRect&&this._videoBackend.clear(),this._streams.forEach(function(b){b.applyDrawEffect&&b.applyDrawEffect(a._videoBackend.getContext(),b.element,d)}),0===this._streams.length&&d()}},VideoStreamMerger.prototype.destroy=function(){this.started=!1,this._videoBackend.destroy(),this._audioBackend.destroy(),this._streams.forEach(function(a){a.element&&a.element.remove()}),this._streams=[],this.result.getTracks().forEach(function(a){a.stop()}),this.result=null},VideoStreamMerger.prototype.getCanvasContext=function(){return this._videoBackend.getContext()},VideoStreamMerger.prototype.getAudioContext=function(){return this._audioCtx.getContext()},VideoStreamMerger.prototype.getAudioDestination=function(){return this._audioBackend.getAudioDestination()};

},{"./backends/audio/webaudio":1,"./backends/video/canvas":2}]},{},[3])(3)
});
